# セキュリティ対応完了 - セットアップガイド

## 🎉 実装完了したセキュリティ機能

### ✅ 1. 環境変数による API キー管理

- API キーとシークレットをソースコードから分離
- `.env.local`ファイルで管理（Git には含まれない）

### ✅ 2. Supabase Auth 認証

- サーバーサイド認証の実装
- セッション管理の自動化
- パスワードの安全なハッシュ化

### ✅ 3. Row Level Security (RLS)

- 認証済みユーザーのみがデータにアクセス可能
- 厳格なアクセス制御ポリシー

### ✅ 4. TypeScript 型安全性

- 環境変数の型定義
- コンパイル時のエラーチェック

---

## 🚀 セットアップ手順

### ステップ 1: 環境変数ファイルの作成

プロジェクトルートに `.env.local` ファイルを作成してください：

```bash
# .env.local
VITE_SUPABASE_URL=your_supabase_project_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### ステップ 2: 管理者ユーザーの作成

以下のいずれかの方法で管理者ユーザーを作成してください：

#### 方法 A: Supabase ダッシュボード（推奨）

1. Supabase ダッシュボードを開く
2. **Authentication** → **Users** → **Add user**
3. 以下を入力：
   - **Email**: 任意のメールアドレス
   - **Password**: 安全なパスワード（8 文字以上推奨）
   - **Auto Confirm User**: ✅ チェック
4. **Create user**をクリック

#### 方法 B: 既存ユーザーを使用

既存のユーザーでログイン：

1. Supabase ダッシュボードでパスワードリセット
2. 新しいパスワードを設定

### ステップ 3: 開発サーバーの起動

```bash
npm run dev
```

### ステップ 4: ログイン

ブラウザで`http://localhost:5173`を開き、作成したアカウントでログイン：

- **Email**: 作成したメールアドレス
- **Password**: 設定したパスワード

---

## 🔒 セキュリティチェックリスト

- [x] API キーを環境変数に移行
- [x] `.env.local`が`.gitignore`に追加済み
- [x] Supabase Auth 認証の実装
- [x] RLS ポリシーの厳格化
- [x] 認証状態の管理を改善
- [x] TypeScript 型定義の追加
- [ ] 管理者ユーザーの作成（手動）
- [ ] `.env.local`ファイルの作成（手動）

---

## 🛡️ セキュリティの改善点

### Before（問題点）

- ❌ API キーがソースコードにハードコード
- ❌ 認証情報がソースコードに含まれる
- ❌ RLS ポリシーが緩い（誰でもアクセス可能）
- ❌ クライアントサイドのみの認証

### After（改善後）

- ✅ API キーは環境変数で管理
- ✅ Supabase Auth によるサーバーサイド認証
- ✅ RLS: 認証済みユーザーのみアクセス可能
- ✅ セッション管理の自動化
- ✅ パスワードの安全なハッシュ化

---

## 📚 追加ドキュメント

- **SECURITY.md**: セキュリティガイド詳細
- **scripts/createAdminUser.ts**: 管理者作成スクリプト

---

## ⚠️ 注意事項

### 本番環境へのデプロイ前に必須の対応

1. **強力なパスワードの使用**

   - 開発用の簡単なパスワードは使用しない
   - 本番環境では必ず強力なパスワードを使用

2. **環境変数の設定**

   - Vercel/Netlify などのホスティングサービスで環境変数を設定

3. **メール確認の有効化**

   - Supabase ダッシュボードで設定
   - Authentication → Providers → Email

4. **HTTPS 接続の使用**
   - 本番環境では必ず HTTPS を使用

---

## 🆘 トラブルシューティング

### エラー: "Supabase 環境変数が設定されていません"

→ `.env.local`ファイルが作成されていません。ステップ 1 を確認してください。

### エラー: "メールアドレスまたはパスワードが間違っています"

→ 管理者ユーザーが作成されていません。ステップ 2 を確認してください。

### リンターエラーが表示される

→ 開発サーバーを再起動してください: `npm run dev`

---

## 📞 サポート

問題が発生した場合は、以下を確認してください：

1. `.env.local`ファイルが正しく作成されているか
2. 管理者ユーザーが作成されているか
3. 開発サーバーが起動しているか
4. ブラウザのコンソールにエラーがないか

すべて完了したら、安全にアプリケーションを使用できます！ 🎉
